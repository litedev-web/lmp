<!DOCTYPE html>

<!--
Lite Music Player
Version: 3.0
Copyright (c) 2026 the Lite developers. All rights reserved.
-->

<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover">
    <title>Lite Music Player</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jsmediatags/3.9.5/jsmediatags.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', 'Microsoft YaHei', sans-serif;
            -webkit-tap-highlight-color: transparent;
            -webkit-user-select: none;
            user-select: none;
        }

        body {
            background: #0b0b1a;
            color: #e0e0e0;
            min-height: 100vh;
            padding: 20px;
            overflow-x: hidden;
            touch-action: manipulation;
        }

        @media (hover: hover) and (pointer: fine) {
            .control-btn:hover {
                background: #3a3a5a;
                transform: none;
                box-shadow: none;
            }

            .control-btn.play-pause:hover {
                background: #5a2ca0;
                box-shadow: none;
            }

            .mode-btn:hover:not(.active) {
                background: #3a3a5a;
            }

            .playlist-item:hover {
                background: #252542;
            }

            .upload-area:hover {
                border: none;
                background: #252542;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .control-btn:active {
                transform: none;
                background: #3a3a5a !important;
            }

            .mode-btn:active {
                background: #3a3a5a !important;
            }

            .playlist-item:active {
                background: #252542;
            }

            .upload-area:active {
                border: none;
                background: #252542;
            }

            .progress-container {
                padding: 10px 0;
                position: relative;
            }

            .progress-bar {
                height: 14px !important;
            }

            .progress {
                height: 100%;
            }

            .progress-bar::before {
                content: '';
                position: absolute;
                top: -10px;
                left: 0;
                right: 0;
                height: 34px;
                z-index: 5;
                cursor: pointer;
            }

            .progress::after {
                content: '';
                position: absolute;
                right: -8px;
                top: 50%;
                width: 16px;
                height: 16px;
                background: #e0e0e0;
                border-radius: 50%;
                transform: translateY(-50%);
                opacity: 1;
                box-shadow: none;
                z-index: 6;
                border: none;
            }
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .main-content {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
        }

        .upload-section, .player-section, .playlist-section {
            background: #1a1a2e;
            border-radius: 8px;
            padding: 25px;
            border: none;
            box-shadow: none;
            position: relative;
            overflow: hidden;
            transition: none;
        }

        @media (hover: hover) and (pointer: fine) {
            .upload-section:hover, .player-section:hover, .playlist-section:hover {
                transform: none;
                box-shadow: none;
            }
        }

        .upload-section::before, .player-section::before, .playlist-section::before {
            display: none;
        }

        .upload-playlist-container {
            flex: 1;
            min-width: 300px;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .player-section {
            flex: 2;
            min-width: 400px;
        }

        .section-title {
            font-size: 1.4rem;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 2px solid #6a11cb;
            display: flex;
            align-items: center;
            color: #ffffff;
        }

        .section-title i {
            margin-right: 10px;
            color: #6a11cb;
        }

        .playlist-header {
            margin-bottom: 20px;
        }

        .playlist-stats {
            font-size: 0.85rem;
            color: #b0b0b0;
            display: flex;
            gap: 15px;
            align-items: center;
            margin-top: 8px;
        }

        .playlist-stat {
            display: inline-flex;
            align-items: center;
        }

        .playlist-stat i {
            margin-right: 5px;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        .upload-area {
            border: none;
            border-radius: 8px;
            padding: 40px 20px;
            text-align: center;
            cursor: pointer;
            transition: none;
            background: #252542;
            touch-action: manipulation;
        }

        .upload-area i {
            font-size: 3rem;
            color: #6a11cb;
            margin-bottom: 15px;
        }

        .upload-area p {
            margin-bottom: 10px;
            color: #e0e0e0;
        }

        .supported-formats {
            font-size: 0.9rem;
            color: #b0b0b0;
            margin-top: 10px;
        }

        #fileInput {
            display: none;
        }

        .playlist-footer {
            margin-top: 20px;
            display: flex;
            justify-content: flex-end;
        }

        .clear-playlist-btn {
            background: #3a1a1a;
            border: none;
            color: #ff6b6b;
            padding: 10px 20px;
            border-radius: 6px;
            cursor: pointer;
            transition: none;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.95rem;
            backdrop-filter: none;
            touch-action: manipulation;
        }

        @media (hover: hover) and (pointer: fine) {
            .clear-playlist-btn:hover {
                background: #4a2a2a;
                transform: none;
                box-shadow: none;
            }
        }

        @media (hover: none) and (pointer: coarse) {
            .clear-playlist-btn:active {
                background: #4a2a2a;
                transform: none;
            }
        }

        .now-playing {
            display: flex;
            align-items: center;
            margin-bottom: 25px;
            background: #252542;
            border-radius: 8px;
            padding: 20px;
            border: none;
        }

        .album-art {
            width: 100px;
            height: 100px;
            border-radius: 8px;
            background: #2d2d4a;
            display: flex;
            align-items: center;
            justify-content: center;
            margin-right: 20px;
            overflow: hidden;
            box-shadow: none;
            transition: none;
            color: #b0b0b0;
        }

        @media (hover: hover) and (pointer: fine) {
            .album-art:hover {
                transform: none;
            }
        }

        .album-art img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }

        .album-art i {
            font-size: 2.5rem;
            color: #6a11cb;
        }

        .song-info h3 {
            font-size: 1.4rem;
            margin-bottom: 5px;
            color: #ffffff;
        }

        .song-info p {
            color: #b0b0b0;
            margin-bottom: 3px;
        }

        .controls {
            display: flex;
            flex-direction: column;
            gap: 20px;
            margin-bottom: 25px;
        }

        .main-controls {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 20px;
        }

        .control-btn {
            background: #2d2d4a;
            border: none;
            color: #e0e0e0;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            font-size: 1.2rem;
            cursor: pointer;
            transition: none;
            display: flex;
            align-items: center;
            justify-content: center;
            backdrop-filter: none;
            border: none;
            touch-action: manipulation;
            position: relative;
            overflow: hidden;
        }

        .control-btn::after {
            display: none;
        }

        .control-btn:active::after {
            display: none;
        }

        .control-btn.play-pause {
            width: 60px;
            height: 60px;
            font-size: 1.6rem;
            background: #6a11cb;
            color: white;
            border: none;
        }

        .secondary-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .mode-selector, .playback-rate, .volume-control, .silence-skipper {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .mode-btn {
            background: #2d2d4a;
            border: none;
            color: #e0e0e0;
            padding: 8px 15px;
            border-radius: 8px;
            cursor: pointer;
            transition: none;
            backdrop-filter: none;
            touch-action: manipulation;
        }

        .mode-btn.active {
            background: #6a11cb;
            border: none;
            color: white;
        }

        .progress-container {
            margin-top: 10px;
            position: relative;
        }

        .progress-bar {
            width: 100%;
            height: 6px;
            background: #2d2d4a;
            border-radius: 4px;
            cursor: pointer;
            position: relative;
            margin-bottom: 5px;
            overflow: hidden;
            touch-action: manipulation;
        }

        @media (hover: hover) and (pointer: fine) {
            .progress-bar:hover {
                height: 6px;
                transition: none;
            }

            .progress-bar:hover .progress {
                height: 100%;
            }
        }

        .progress-bar::before {
            display: none;
        }

        .progress {
            height: 100%;
            background: #6a11cb;
            border-radius: 4px;
            width: 0%;
            transition: width 0.1s;
            position: relative;
            z-index: 1;
        }

        @media (hover: hover) and (pointer: fine) {
            .progress::after {
                display: none;
            }

            .progress-bar:hover .progress::after {
                display: none;
            }
        }

        .time-display {
            display: flex;
            justify-content: space-between;
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        @media (hover: none) and (pointer: coarse) {
            .time-display {
                font-size: 1rem;
            }
        }

        .playlist {
            max-height: 300px;
            overflow-y: auto;
            border-radius: 8px;
            background: #1a1a2e;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
            touch-action: pan-y;
            border: none;
        }

        .playlist::-webkit-scrollbar {
            width: 6px;
        }

        .playlist::-webkit-scrollbar-track {
            background: #1a1a2e;
            border-radius: 0;
        }

        .playlist::-webkit-scrollbar-thumb {
            background: #4a4a6a;
            border-radius: 0;
        }

        .playlist-item {
            display: flex;
            align-items: center;
            padding: 15px;
            border-bottom: 1px solid #252542;
            cursor: pointer;
            transition: none;
            min-height: 60px;
            touch-action: pan-y;
            touch-action: manipulation;
            position: relative;
            border-radius: 4px;
        }

        .playlist-item.active {
            background: #252542;
            border-left: 4px solid #6a11cb;
        }

        .playlist-item i {
            margin-right: 15px;
            color: #6a11cb;
        }

        .playlist-info {
            flex: 1;
        }

        .playlist-info h4 {
            margin-bottom: 3px;
            font-size: 1rem;
            color: #ffffff;
        }

        .playlist-info p {
            font-size: 0.85rem;
            color: #b0b0b0;
        }

        .playlist-duration {
            font-size: 0.9rem;
            color: #b0b0b0;
        }

        @media (max-width: 768px) {
            .main-content {
                flex-direction: column;
            }

            .upload-playlist-container, .player-section {
                min-width: 100%;
            }

            .secondary-controls {
                flex-direction: column;
                align-items: flex-start;
            }

            .control-btn {
                min-width: 50px;
                min-height: 50px;
            }

            .control-btn.play-pause {
                min-width: 60px;
                min-height: 60px;
            }

            .album-art {
                width: 80px;
                height: 80px;
            }

            .song-info h3 {
                font-size: 1.2rem;
            }

            .progress-bar {
                height: 16px !important;
            }

            .progress-container {
                padding: 15px 0;
            }

            .playlist-stats {
                font-size: 0.8rem;
                gap: 10px;
                flex-wrap: wrap;
            }
        }

        .loading {
            position: absolute;
            width: 20px;
            height: 20px;
            border: 2px solid #2d2d4a;
            border-top-color: #6a11cb;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            display: none;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .switch {
            position: relative;
            display: inline-block;
            width: 50px;
            height: 24px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #2d2d4a;
            border: none;
            transition: .2s;
            border-radius: 12px;
        }

        .slider:before {
            position: absolute;
            content: "";
            height: 16px;
            width: 16px;
            left: 4px;
            bottom: 4px;
            background-color: #e0e0e0;
            transition: .2s;
            border-radius: 50%;
            border: none;
        }

        input:checked + .slider {
            background-color: #6a11cb;
            border: none;
        }

        input:checked + .slider:before {
            transform: translateX(26px);
            background-color: white;
        }
    </style>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
</head>
<body>
    <div class="container">
        <div class="main-content">
            <div class="upload-playlist-container">
                <section class="playlist-section">
                    <div class="playlist-header">
                        <h2 class="section-title">
                            <i class="fas fa-list"></i> Playlist
                        </h2>
                        <div class="playlist-stats" id="playlistStats">
                            <span class="playlist-stat">
                                <i class="fas fa-music"></i> <span id="playlistFileCount">0 files</span>
                            </span>
                            <span class="playlist-stat">
                                <i class="fas fa-clock"></i> <span id="playlistDuration">0:00</span>
                            </span>
                        </div>
                    </div>
                    <div class="playlist" id="playlist">
                        <div class="playlist-item empty">
                            <i class="fas fa-music"></i>
                            <div class="playlist-info">
                                <h4>Playlist is empty</h4>
                                <p>Upload music files to start playing</p>
                            </div>
                        </div>
                    </div>
                    <div class="playlist-footer">
                        <button class="clear-playlist-btn" id="clearPlaylistBtn">
                            <i class="fas fa-trash-alt"></i> Clear Playlist
                        </button>
                    </div>
                </section>

                <section class="upload-section">
                    <h2 class="section-title"><i class="fas fa-upload"></i> Upload Music</h2>
                    <div class="upload-area" id="uploadArea">
                        <i class="fas fa-music"></i>
                        <p>Click to select files or drag and drop here</p>
                        <p>Supported formats: MP3, FLAC, OGG, WAV, M4A, AAC</p>
                        <input type="file" id="fileInput" accept=".mp3,.flac,.ogg,.wav,.m4a,.aac" multiple>
                    </div>
                </section>
            </div>

            <section class="player-section">
                <div class="now-playing" id="nowPlaying">
                    <div class="album-art" id="albumArt">
                        <i class="fas fa-music"></i>
                    </div>
                    <div class="song-info">
                        <h3 id="currentTitle">No song selected</h3>
                        <p id="currentArtist">-</p>
                        <p id="currentAlbum">-</p>
                    </div>
                </div>

                <div class="controls">
                    <div class="progress-container" id="progressContainer">
                        <div class="progress-bar" id="progressBar">
                            <div class="progress" id="progress"></div>
                        </div>
                        <div class="time-display">
                            <span id="currentTime">0:00</span>
                            <span id="duration">0:00</span>
                        </div>
                    </div>

                    <div class="main-controls">
                        <button class="control-btn" id="prevBtn" title="Previous">
                            <i class="fas fa-step-backward"></i>
                        </button>
                        <button class="control-btn play-pause" id="playPauseBtn" title="Play/Pause">
                            <i class="fas fa-play" id="playIcon"></i>
                        </button>
                        <button class="control-btn" id="nextBtn" title="Next">
                            <i class="fas fa-step-forward"></i>
                        </button>
                    </div>

                    <div class="secondary-controls">
                        <div class="mode-selector">
                            <span>Mode:</span>
                            <button class="mode-btn active" data-mode="sequential" id="modeSequential" title="Sequential">
                                <i class="fas fa-list-ol"></i>
                            </button>
                            <button class="mode-btn" data-mode="list_loop" id="modeListLoop" title="List Loop">
                                <i class="fas fa-retweet"></i>
                            </button>
                            <button class="mode-btn" data-mode="single_loop" id="modeSingleLoop" title="Single Loop">
                                <i class="fas fa-redo"></i>
                            </button>
                            <button class="mode-btn" data-mode="shuffle" id="modeShuffle" title="Shuffle">
                                <i class="fas fa-random"></i>
                            </button>
                        </div>

                        <div class="playback-rate">
                            <span>Speed:</span>
                            <button class="control-btn" id="speedDown" title="Slower" style="width:40px;height:40px;">
                                <i class="fas fa-minus"></i>
                            </button>
                            <span id="currentSpeed">1.0x</span>
                            <button class="control-btn" id="speedUp" title="Faster" style="width:40px;height:40px;">
                                <i class="fas fa-plus"></i>
                            </button>
                        </div>

                        <div class="silence-skipper">
                            <span>Skip Silence:</span>
                            <label class="switch">
                                <input type="checkbox" id="skipSilenceCheckbox">
                                <span class="slider"></span>
                            </label>
                        </div>

                        <div class="volume-control">
                            <span>Volume:</span>
                            <button class="control-btn" id="muteBtn" title="Mute" style="width:40px;height:40px;">
                                <i class="fas fa-volume-up" id="volumeIcon"></i>
                            </button>
                            <input type="range" id="volumeSlider" min="0" max="100" value="100" style="width:100px;">
                        </div>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <script src="filemgr.js"></script>
    <script src="plyctrl.js"></script>
    <script src="slcskip.js"></script>

    <script>
        const log = (() => {
            const PREFIX = '[Player]';
            return {
                info: (msg, data) => console.log(`${PREFIX} ${msg}`, data || ''),
                error: (msg, err) => console.error(`${PREFIX} ${msg}`, err || ''),
                warn: (msg, data) => console.warn(`${PREFIX} ${msg}`, data || ''),
                debug: (msg, data) => console.debug(`${PREFIX} ${msg}`, data || '')
            };
        })();

        let hasUserInteracted = false;

        function initializeAutoPlay() {
            const body = document.body;
            const handleFirstInteraction = () => {
                hasUserInteracted = true;
                log.info('User interaction detected, autoplay enabled');
                body.removeEventListener('click', handleFirstInteraction);
                body.removeEventListener('touchstart', handleFirstInteraction);
                body.removeEventListener('keydown', handleFirstInteraction);
            };
            body.addEventListener('click', handleFirstInteraction, { once: true });
            body.addEventListener('touchstart', handleFirstInteraction, { once: true });
            body.addEventListener('keydown', handleFirstInteraction, { once: true });
        }

        function safePlayAudio(audioElement) {
            if (!audioElement) return;
            if (hasUserInteracted) {
                const playPromise = audioElement.play();
                if (playPromise !== undefined) {
                    playPromise.catch(error => {
                        log.error('Autoplay prevented', error);
                    });
                }
            }
        }

        document.addEventListener('DOMContentLoaded', function() {
            log.info('DOM loaded, initializing player');
            initializeAutoPlay();

            const fileManager = new FileManager();
            const playerController = new PlayerController(fileManager);
            const silenceSkipper = new SilenceSkipper(playerController, fileManager);

            const uploadArea = document.getElementById('uploadArea');
            const fileInput = document.getElementById('fileInput');
            const clearPlaylistBtn = document.getElementById('clearPlaylistBtn');
            const playPauseBtn = document.getElementById('playPauseBtn');
            const prevBtn = document.getElementById('prevBtn');
            const nextBtn = document.getElementById('nextBtn');
            const progressContainer = document.getElementById('progressContainer');
            const progressBar = document.getElementById('progressBar');
            const progress = document.getElementById('progress');
            const currentTimeEl = document.getElementById('currentTime');
            const durationEl = document.getElementById('duration');
            const playlistEl = document.getElementById('playlist');
            const albumArtEl = document.getElementById('albumArt');
            const currentTitleEl = document.getElementById('currentTitle');
            const currentArtistEl = document.getElementById('currentArtist');
            const currentAlbumEl = document.getElementById('currentAlbum');
            const playlistFileCountEl = document.getElementById('playlistFileCount');
            const playlistDurationEl = document.getElementById('playlistDuration');
            const modeButtons = {
                sequential: document.getElementById('modeSequential'),
                list_loop: document.getElementById('modeListLoop'),
                single_loop: document.getElementById('modeSingleLoop'),
                shuffle: document.getElementById('modeShuffle')
            };
            const speedDownBtn = document.getElementById('speedDown');
            const speedUpBtn = document.getElementById('speedUp');
            const currentSpeedEl = document.getElementById('currentSpeed');
            const muteBtn = document.getElementById('muteBtn');
            const volumeSlider = document.getElementById('volumeSlider');
            const volumeIcon = document.getElementById('volumeIcon');
            const skipSilenceCheckbox = document.getElementById('skipSilenceCheckbox');
            const isTouchDevice = 'ontouchstart' in window || navigator.maxTouchPoints > 0;
            const isDesktop = window.matchMedia('(hover: hover) and (pointer: fine)').matches;

            function createUniversalEventHandler(element, callback, options = {}) {
                let isTouch = false;
                let touchStartTime = 0;
                let touchStartX = 0;
                let touchStartY = 0;

                if (element.classList.contains('playlist')) {
                    element.addEventListener('touchstart', (e) => {}, { passive: true });
                    element.addEventListener('touchmove', (e) => {}, { passive: true });
                    return;
                }

                if (element.classList.contains('playlist-item')) {
                    element.addEventListener('touchstart', (e) => {
                        isTouch = true;
                        touchStartTime = Date.now();
                        touchStartX = e.touches[0].clientX;
                        touchStartY = e.touches[0].clientY;
                        if (!options.noFeedback) {
                            element.style.transform = 'scale(0.98)';
                            element.style.backgroundColor = options.feedbackColor || 'rgba(106, 17, 203, 0.1)';
                        }
                    }, { passive: true });

                    element.addEventListener('touchmove', (e) => {
                        if (!isTouch) return;
                        const touchMoveX = e.touches[0].clientX;
                        const touchMoveY = e.touches[0].clientY;
                        const dx = Math.abs(touchMoveX - touchStartX);
                        const dy = Math.abs(touchMoveY - touchStartY);
                        if (dx > 10 || dy > 10) {
                            isTouch = false;
                            if (!options.noFeedback) {
                                element.style.transform = '';
                                element.style.backgroundColor = '';
                            }
                        }
                    }, { passive: true });

                    element.addEventListener('touchend', (e) => {
                        if (!isTouch) return;
                        const touchEndTime = Date.now();
                        const isLongPress = touchEndTime - touchStartTime > 500;
                        if (!isLongPress) {
                            callback(e);
                        }
                        if (!options.noFeedback) {
                            element.style.transform = '';
                            element.style.backgroundColor = '';
                        }
                        isTouch = false;
                    }, { passive: true });

                    element.addEventListener('touchcancel', () => {
                        if (!options.noFeedback) {
                            element.style.transform = '';
                            element.style.backgroundColor = '';
                        }
                        isTouch = false;
                    });

                    element.addEventListener('click', (e) => {
                        if (isTouch) return;
                        callback(e);
                    });
                    return;
                }

                element.addEventListener('touchstart', (e) => {
                    isTouch = true;
                    touchStartTime = Date.now();
                    touchStartX = e.touches[0].clientX;
                    touchStartY = e.touches[0].clientY;
                    if (!options.noFeedback) {
                        element.style.transform = 'scale(0.95)';
                        element.style.backgroundColor = options.feedbackColor || 'rgba(106, 17, 203, 0.7)';
                    }
                    e.preventDefault();
                }, { passive: false });

                element.addEventListener('touchend', (e) => {
                    if (!isTouch) return;
                    const touchEndTime = Date.now();
                    const touchEndX = e.changedTouches[0].clientX;
                    const touchEndY = e.changedTouches[0].clientY;
                    const dx = Math.abs(touchEndX - touchStartX);
                    const dy = Math.abs(touchEndY - touchStartY);
                    const isSwipe = dx > 10 || dy > 10;
                    const isLongPress = touchEndTime - touchStartTime > 500;
                    if (!isSwipe && !isLongPress) {
                        callback(e);
                    }
                    if (!options.noFeedback) {
                        element.style.transform = '';
                        element.style.backgroundColor = '';
                    }
                    isTouch = false;
                    e.preventDefault();
                }, { passive: false });

                element.addEventListener('touchcancel', () => {
                    if (!options.noFeedback) {
                        element.style.transform = '';
                        element.style.backgroundColor = '';
                    }
                    isTouch = false;
                });

                element.addEventListener('click', (e) => {
                    if (isTouch) return;
                    callback(e);
                });

                if (isDesktop && !options.noHover) {
                    element.addEventListener('mouseenter', () => {
                        if (!isTouch) {
                            element.style.cursor = 'pointer';
                        }
                    });
                    element.addEventListener('mouseleave', () => {
                        if (!options.noFeedback) {
                            element.style.transform = '';
                            element.style.backgroundColor = '';
                        }
                    });
                }
            }

            function updatePlaylist() {
                const playlist = fileManager.getPlaylist();
                const currentFileId = playerController.currentFileId;
                playlistEl.innerHTML = '';
                if (playlist.length === 0) {
                    const emptyItem = document.createElement('div');
                    emptyItem.className = 'playlist-item empty';
                    emptyItem.innerHTML = `
                        <i class="fas fa-music"></i>
                        <div class="playlist-info">
                            <h4>Playlist is empty</h4>
                            <p>Upload music files to start playing</p>
                        </div>
                    `;
                    playlistEl.appendChild(emptyItem);
                    return;
                }
                playlist.forEach((file) => {
                    const item = document.createElement('div');
                    item.className = 'playlist-item';
                    if (file.id === currentFileId) {
                        item.classList.add('active');
                    }
                    const duration = file.metadata.duration || 0;
                    const minutes = Math.floor(duration / 60);
                    const seconds = Math.floor(duration % 60).toString().padStart(2, '0');
                    item.innerHTML = `
                        <i class="fas fa-music"></i>
                        <div class="playlist-info">
                            <h4>${file.metadata.title || file.fileName}</h4>
                            <p>${file.metadata.artist || 'Unknown Artist'} â€¢ ${file.metadata.album || 'Unknown Album'}</p>
                        </div>
                        <div class="playlist-duration">${minutes}:${seconds}</div>
                    `;
                    createUniversalEventHandler(item, () => {
                        log.info('Playlist item clicked', file.id);
                        playerController.playFile(file.id).catch(error => {
                            log.error('Play failed', error);
                        });
                    });
                    playlistEl.appendChild(item);
                });
                log.debug('Playlist updated', { count: playlist.length, currentId: currentFileId });
            }

            function updatePlaylistStats() {
                const playlist = fileManager.getPlaylist();
                playlistFileCountEl.textContent = `${playlist.length} file${playlist.length !== 1 ? 's' : ''}`;
                const totalDuration = playlist.reduce((sum, file) => sum + (file.metadata.duration || 0), 0);
                const totalMinutes = Math.floor(totalDuration / 60);
                const totalHours = Math.floor(totalMinutes / 60);
                const remainingMinutes = totalMinutes % 60;
                if (totalHours > 0) {
                    playlistDurationEl.textContent = `${totalHours}h ${remainingMinutes}m`;
                } else {
                    playlistDurationEl.textContent = `${totalMinutes}m`;
                }
                log.debug('Playlist stats updated', { count: playlist.length, totalDuration });
            }

            function updateNowPlaying() {
                const info = playerController.getCurrentPlaybackInfo();
                if (info.currentFile) {
                    const file = info.currentFile;
                    currentTitleEl.textContent = file.metadata.title || file.fileName;
                    currentArtistEl.textContent = file.metadata.artist || 'Unknown Artist';
                    currentAlbumEl.textContent = file.metadata.album || 'Unknown Album';
                    albumArtEl.innerHTML = '';
                    if (file.metadata.picture) {
                        const img = document.createElement('img');
                        img.src = file.metadata.picture;
                        img.alt = 'Album Art';
                        img.onload = () => log.debug('Album art loaded', file.metadata.picture);
                        img.onerror = () => log.error('Album art failed to load', file.metadata.picture);
                        albumArtEl.appendChild(img);
                    } else {
                        albumArtEl.innerHTML = '<i class="fas fa-music"></i>';
                    }
                    log.info('Now playing updated', { title: file.metadata.title, id: file.id });
                } else {
                    currentTitleEl.textContent = 'No song selected';
                    currentArtistEl.textContent = '-';
                    currentAlbumEl.textContent = '-';
                    albumArtEl.innerHTML = '<i class="fas fa-music"></i>';
                    log.info('Now playing cleared');
                }
            }

            function updateProgress(currentTime, duration) {
                if (duration && duration > 0) {
                    const percent = (currentTime / duration) * 100;
                    progress.style.width = `${percent}%`;
                    const formatTime = (time) => {
                        const minutes = Math.floor(time / 60);
                        const seconds = Math.floor(time % 60).toString().padStart(2, '0');
                        return `${minutes}:${seconds}`;
                    };
                    currentTimeEl.textContent = formatTime(currentTime);
                    durationEl.textContent = formatTime(duration);
                }
            }

            function updatePlayButton(isPlaying) {
                const playIcon = document.getElementById('playIcon');
                if (isPlaying) {
                    playIcon.className = 'fas fa-pause';
                    playPauseBtn.title = 'Pause';
                } else {
                    playIcon.className = 'fas fa-play';
                    playPauseBtn.title = 'Play';
                }
                log.debug('Play button updated', { isPlaying });
            }

            function updateModeButtons(mode) {
                Object.values(modeButtons).forEach(btn => btn.classList.remove('active'));
                if (modeButtons[mode]) {
                    modeButtons[mode].classList.add('active');
                }
                log.debug('Mode buttons updated', { mode });
            }

            function updateSpeedDisplay() {
                currentSpeedEl.textContent = `${playerController.playbackRate.toFixed(1)}x`;
                log.debug('Speed display updated', { rate: playerController.playbackRate });
            }

            function updateVolumeDisplay(volume, isMuted) {
                volumeSlider.value = volume * 100;
                if (isMuted || volume === 0) {
                    volumeIcon.className = 'fas fa-volume-mute';
                } else if (volume < 0.5) {
                    volumeIcon.className = 'fas fa-volume-down';
                } else {
                    volumeIcon.className = 'fas fa-volume-up';
                }
                log.debug('Volume display updated', { volume, isMuted });
            }

            function setupProgressBarEvents() {
                let isDragging = false;
                let animationFrameId = null;

                const handleProgressInteraction = (e) => {
                    if (animationFrameId) {
                        cancelAnimationFrame(animationFrameId);
                    }
                    animationFrameId = requestAnimationFrame(() => {
                        const rect = progressBar.getBoundingClientRect();
                        let clientX;
                        if (e.type.includes('touch')) {
                            clientX = e.touches[0].clientX;
                        } else {
                            clientX = e.clientX;
                        }
                        const percent = (clientX - rect.left) / rect.width;
                        const boundedPercent = Math.max(0, Math.min(1, percent));
                        playerController.seekByPercentage(boundedPercent * 100);
                        if (isTouchDevice && e.type.includes('touch')) {
                            progress.style.transition = 'none';
                            setTimeout(() => {
                                progress.style.transition = 'width 0.1s';
                            }, 100);
                        }
                    });
                };

                if (isTouchDevice) {
                    progressContainer.addEventListener('touchstart', (e) => {
                        isDragging = true;
                        handleProgressInteraction(e);
                        progress.style.backgroundColor = 'rgba(106, 17, 203, 0.9)';
                    }, { passive: false });

                    progressContainer.addEventListener('touchmove', (e) => {
                        if (isDragging) {
                            handleProgressInteraction(e);
                        }
                    }, { passive: false });

                    progressContainer.addEventListener('touchend', (e) => {
                        isDragging = false;
                        progress.style.backgroundColor = '';
                        log.debug('Progress bar touch ended');
                    });

                    progressContainer.addEventListener('touchcancel', () => {
                        isDragging = false;
                        progress.style.backgroundColor = '';
                        log.debug('Progress bar touch cancelled');
                    });
                }

                progressBar.addEventListener('click', (e) => {
                    if (!isTouchDevice) {
                        handleProgressInteraction(e);
                        log.debug('Progress bar clicked');
                    }
                });

                if (isDesktop) {
                    progressBar.addEventListener('mousedown', (e) => {
                        isDragging = true;
                        handleProgressInteraction(e);
                        const handleMouseMove = (moveEvent) => {
                            if (isDragging) {
                                handleProgressInteraction(moveEvent);
                            }
                        };
                        const handleMouseUp = () => {
                            isDragging = false;
                            document.removeEventListener('mousemove', handleMouseMove);
                            document.removeEventListener('mouseup', handleMouseUp);
                            log.debug('Progress bar mouse up');
                        };
                        document.addEventListener('mousemove', handleMouseMove);
                        document.addEventListener('mouseup', handleMouseUp);
                    });
                }

                progressContainer.addEventListener('dragstart', (e) => {
                    e.preventDefault();
                });
            }

            function setupEventListeners() {
                createUniversalEventHandler(uploadArea, () => {
                    log.info('Upload area clicked');
                    fileInput.click();
                });

                uploadArea.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = '#6a11cb';
                    uploadArea.style.background = 'rgba(106, 17, 203, 0.1)';
                });

                uploadArea.addEventListener('dragleave', () => {
                    uploadArea.style.borderColor = 'rgba(106, 17, 203, 0.5)';
                    uploadArea.style.background = '';
                });

                uploadArea.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadArea.style.borderColor = 'rgba(106, 17, 203, 0.5)';
                    uploadArea.style.background = '';
                    if (e.dataTransfer.files.length > 0) {
                        log.info('Files dropped', { count: e.dataTransfer.files.length });
                        handleFiles(e.dataTransfer.files);
                    }
                });

                fileInput.addEventListener('change', (e) => {
                    if (e.target.files.length > 0) {
                        log.info('Files selected via input', { count: e.target.files.length });
                        handleFiles(e.target.files);
                    }
                });

                createUniversalEventHandler(clearPlaylistBtn, () => {
                    log.info('Clear playlist button clicked');
                    fileManager.clearPlaylist();
                    playerController.currentFileId = null;
                    playerController.pause();
                    updatePlaylist();
                    updatePlaylistStats();
                    updateNowPlaying();
                });

                createUniversalEventHandler(playPauseBtn, () => {
                    hasUserInteracted = true;
                    log.info('Play/Pause button clicked');
                    playerController.togglePlayPause().catch(error => {
                        log.error('Play failed', error);
                    });
                });

                createUniversalEventHandler(prevBtn, () => {
                    hasUserInteracted = true;
                    log.info('Previous button clicked');
                    playerController.previous().catch(error => {
                        log.error('Previous failed', error);
                    });
                });

                createUniversalEventHandler(nextBtn, () => {
                    hasUserInteracted = true;
                    log.info('Next button clicked');
                    playerController.next().catch(error => {
                        log.error('Next failed', error);
                    });
                });

                setupProgressBarEvents();

                Object.keys(modeButtons).forEach(mode => {
                    const button = modeButtons[mode];
                    createUniversalEventHandler(button, () => {
                        log.info('Mode button clicked', { mode });
                        playerController.setPlayMode(mode);
                    });
                });

                createUniversalEventHandler(speedDownBtn, () => {
                    const newRate = Math.max(0.5, playerController.playbackRate - 0.1);
                    log.info('Speed down button clicked', { newRate });
                    playerController.setPlaybackRate(newRate);
                });

                createUniversalEventHandler(speedUpBtn, () => {
                    const newRate = Math.min(3.0, playerController.playbackRate + 0.1);
                    log.info('Speed up button clicked', { newRate });
                    playerController.setPlaybackRate(newRate);
                });

                volumeSlider.addEventListener('input', (e) => {
                    const volume = e.target.value / 100;
                    log.debug('Volume slider input', { volume });
                    playerController.setVolume(volume);
                });

                if (isTouchDevice) {
                    volumeSlider.addEventListener('touchstart', (e) => {
                        e.stopPropagation();
                    }, { passive: true });
                    volumeSlider.addEventListener('touchmove', (e) => {
                        e.stopPropagation();
                    }, { passive: true });
                }

                createUniversalEventHandler(muteBtn, () => {
                    log.info('Mute button clicked');
                    playerController.toggleMute();
                });

                skipSilenceCheckbox.addEventListener('change', async () => {
                    if (skipSilenceCheckbox.checked) {
                        log.info('Skip silence enabled');
                        try {
                            await silenceSkipper.enable();
                        } catch (error) {
                            log.error('Failed to enable silence skipper', error);
                            skipSilenceCheckbox.checked = false;
                        }
                    } else {
                        log.info('Skip silence disabled');
                        silenceSkipper.disable();
                    }
                });

                if (isDesktop) {
                    document.addEventListener('keydown', (e) => {
                        if (e.code === 'Space' && e.target === document.body) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            log.info('Space key pressed for play/pause');
                            playPauseBtn.click();
                        }
                        if (e.code === 'ArrowLeft' && e.ctrlKey) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            log.info('Ctrl+ArrowLeft pressed for previous');
                            prevBtn.click();
                        }
                        if (e.code === 'ArrowRight' && e.ctrlKey) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            log.info('Ctrl+ArrowRight pressed for next');
                            nextBtn.click();
                        }
                        if (e.code === 'ArrowUp' && e.ctrlKey) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            const currentVolume = parseFloat(volumeSlider.value) / 100;
                            const newVolume = Math.min(1, currentVolume + 0.1);
                            log.info('Ctrl+ArrowUp pressed for volume up', { newVolume });
                            playerController.setVolume(newVolume);
                        }
                        if (e.code === 'ArrowDown' && e.ctrlKey) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            const currentVolume = parseFloat(volumeSlider.value) / 100;
                            const newVolume = Math.max(0, currentVolume - 0.1);
                            log.info('Ctrl+ArrowDown pressed for volume down', { newVolume });
                            playerController.setVolume(newVolume);
                        }
                        if (e.code === 'KeyM' && e.ctrlKey) {
                            e.preventDefault();
                            hasUserInteracted = true;
                            log.info('Ctrl+M pressed for mute');
                            muteBtn.click();
                        }
                    });
                }

                log.info('Event listeners setup completed');
            }

            async function handleFiles(files) {
                try {
                    log.info('Processing files', { count: files.length });
                    await fileManager.addFiles(files);
                    updatePlaylist();
                    updatePlaylistStats();
                    if (!playerController.currentFileId && fileManager.getPlaylist().length > 0) {
                        const firstFile = fileManager.getPlaylist()[0];
                        log.info('Auto-playing first file', { id: firstFile.id });
                        await playerController.playFile(firstFile.id);
                    }
                    log.info('Files processed successfully', { count: files.length });
                } catch (error) {
                    log.error('File processing failed', error);
                }
            }

            setupEventListeners();

            playerController.onPlay = () => {
                log.info('Player play event');
                updatePlayButton(true);
            };
            playerController.onPause = () => {
                log.info('Player pause event');
                updatePlayButton(false);
            };
            playerController.onSongChange = (file) => {
                log.info('Player song change event', { id: file?.id });
                updateNowPlaying();
                updatePlaylist();
                updatePlaylistStats();
            };
            playerController.onTimeUpdate = (currentTime, duration) => {
                updateProgress(currentTime, duration);
            };
            playerController.onVolumeChange = (volume, isMuted) => {
                log.debug('Player volume change event', { volume, isMuted });
                updateVolumeDisplay(volume, isMuted);
            };
            playerController.onPlaybackRateChange = (rate) => {
                log.debug('Player playback rate change event', { rate });
                updateSpeedDisplay();
            };
            playerController.onModeChange = (mode) => {
                log.info('Player mode change event', { mode });
                updateModeButtons(mode);
            };

            silenceSkipper.onEnabled = () => {
                log.info('Silence skipper enabled');
                skipSilenceCheckbox.checked = true;
            };
            silenceSkipper.onDisabled = () => {
                log.info('Silence skipper disabled');
                skipSilenceCheckbox.checked = false;
            };
            silenceSkipper.onSkip = (fromFileId, toFileId) => {
                log.info('Silence skip occurred', { from: fromFileId, to: toFileId });
                updatePlaylist();
                updateNowPlaying();
            };

            window.addEventListener('beforeunload', () => {
                log.info('Page unload, cleaning up');
                if (silenceSkipper.isEnabled) {
                    silenceSkipper.disable();
                }
                silenceSkipper.destroy();
                if (playerController) {
                    playerController.pause();
                }
            });

            fileManager.initialize();
            updatePlaylistStats();
            updateModeButtons(playerController.currentMode);
            updateSpeedDisplay();
            updateVolumeDisplay(playerController.volume, playerController.isMuted);
            log.info('Player initialization complete');
        });
    </script>
</body>
</html>
